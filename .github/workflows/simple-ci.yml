# ==========================================
# NutriFit Platform - CI/CD Pipeline
# ==========================================
# Build & Test - Render Deploy Automatico via Blueprint

name: 🚀 NutriFit Platform CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Permissions for creating releases
permissions:
  contents: write
  packages: read

env:
  PYTHON_VERSION: "3.11"
  POETRY_VERSION: "1.6.1"

jobs:
  # ====================================
  # Detect Service Changes  
  # ====================================
  detect-changes:
    name: 🔍 Detect Changes
    runs-on: ubuntu-latest
    outputs:
      user-management: ${{ steps.changes.outputs.user-management }}
      calorie-balance: ${{ steps.changes.outputs.calorie-balance }}
      
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔍 Detect Service Changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            user-management:
              - 'services/user-management/**'
            calorie-balance:
              - 'services/calorie-balance/**'

  # ====================================
  # Test User Management Service
  # ====================================
  test-user-management:
    name: 🧪 Test User Management
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.user-management == 'true' || github.event_name == 'pull_request'
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 📦 Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: 🔄 Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ./services/user-management/.venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('services/user-management/poetry.lock') }}

      - name: 📦 Install Dependencies
        working-directory: ./services/user-management
        run: poetry install --no-interaction

      - name: 🧪 Run Tests
        working-directory: ./services/user-management
        run: |
          poetry run pytest tests/ -v --tb=short
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'mock://test' }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || 'mock-key' }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'mock-key' }}
          JWT_SECRET: test-secret-key

      - name: ✅ Tests Complete
        run: |
          echo "🎉 User Management tests passed!"
          echo "🚀 Render will auto-deploy on push to main"

  # ====================================  
  # Test Calorie Balance Service
  # ====================================
  test-calorie-balance:
    name: 🧪 Test Calorie Balance  
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.calorie-balance == 'true' || github.event_name == 'pull_request'
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 📦 Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: 🔄 Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ./services/calorie-balance/.venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('services/calorie-balance/poetry.lock') }}

      - name: 📦 Install Dependencies
        working-directory: ./services/calorie-balance
        run: poetry install --no-interaction

      - name: 🧪 Run Tests
        working-directory: ./services/calorie-balance
        run: |
          poetry run pytest tests/ -v --tb=short
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'mock://test' }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || 'mock-key' }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'mock-key' }}
          JWT_SECRET: test-secret-key

      - name: ✅ Tests Complete
        run: |
          echo "🎉 Calorie Balance tests passed!"
          echo "🚀 Render will auto-deploy on push to main"

  # ====================================
  # Release (solo su main)
  # ====================================
  release:
    name: 📦 Create Release
    runs-on: ubuntu-latest
    needs: [test-user-management, test-calorie-balance]
    if: always() && github.ref == 'refs/heads/main' && (needs.test-user-management.result == 'success' || needs.test-user-management.result == 'skipped') && (needs.test-calorie-balance.result == 'success' || needs.test-calorie-balance.result == 'skipped')
    
    steps:
      - name: 🎉 Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: platform-v${{ github.run_number }}
          name: NutriFit Platform v${{ github.run_number }}
          body: |
            ## 🚀 Platform Release
            
            **Automatic deployment via Render Blueprint**
            
            ### Services
            - User Management: Auto-deployed to production
            - Calorie Balance: Auto-deployed to production
            
            ### Infrastructure
            - Database: Supabase Cloud
            - Hosting: Render.com  
            - CI/CD: GitHub Actions + Render Auto-Deploy
            
            **Deploy Status**: Check [Render Dashboard](https://dashboard.render.com)
          generate_release_notes: true
