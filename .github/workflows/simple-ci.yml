# ==========================================
# NutriFit Platform - CI/CD Pipeline
# ==========================================
# Build, Test & Release - Render Deploy Automatico via Blueprint

name: ğŸš€ NutriFit Platform CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Permissions for creating releases and pushing to registry
permissions:
  contents: write
  packages: write
  id-token: write

env:
  PYTHON_VERSION: "3.11"
  POETRY_VERSION: "1.6.1"
  DOCKER_REGISTRY: ghcr.io

jobs:
  # ====================================
  # Detect Service Changes  
  # ====================================
  detect-changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      user-management: ${{ steps.changes.outputs.user-management }}
      calorie-balance: ${{ steps.changes.outputs.calorie-balance }}
      
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detect Service Changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            user-management:
              - 'services/user-management/**'
            calorie-balance:
              - 'services/calorie-balance/**'

  # ====================================
  # Test User Management Service
  # ====================================
  test-user-management:
    name: ğŸ§ª Test User Management
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.user-management == 'true' || github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ğŸ”„ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ./services/user-management/.venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('services/user-management/poetry.lock') }}

      - name: ğŸ“¦ Install Dependencies
        working-directory: ./services/user-management
        run: poetry install --no-interaction

      - name: ğŸ§ª Run Tests
        working-directory: ./services/user-management
        run: |
          poetry run pytest tests/ -v --tb=short
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'mock://test' }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || 'mock-key' }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'mock-key' }}
          JWT_SECRET: test-secret-key

      - name: ğŸ³ Docker Build Test
        working-directory: ./services/user-management
        run: |
          echo "ğŸ—ï¸ Testing Docker build..."
          docker build --target production -t user-management:test .
          echo "âœ… Docker build successful!"

      - name: âœ… Tests Complete
        run: |
          echo "ğŸ‰ User Management tests passed!"
          echo "ğŸš€ Render will auto-deploy on push to main"

  # ====================================  
  # Test Calorie Balance Service
  # ====================================
  test-calorie-balance:
    name: ğŸ§ª Test Calorie Balance  
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.calorie-balance == 'true' || github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ğŸ”„ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ./services/calorie-balance/.venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('services/calorie-balance/poetry.lock') }}

      - name: ğŸ“¦ Install Dependencies
        working-directory: ./services/calorie-balance
        run: poetry install --no-interaction

      - name: ğŸ§ª Run Tests
        working-directory: ./services/calorie-balance
        run: |
          poetry run pytest tests/ -v --tb=short
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'mock://test' }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || 'mock-key' }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'mock-key' }}
          JWT_SECRET: test-secret-key

      - name: ğŸ³ Docker Build Test
        working-directory: ./services/calorie-balance
        run: |
          echo "ğŸ—ï¸ Testing Docker build..."
          docker build --target production -t calorie-balance:test .
          echo "âœ… Docker build successful!"

      - name: âœ… Tests Complete
        run: |
          echo "ğŸ‰ Calorie Balance tests passed!"
          echo "ğŸš€ Render will auto-deploy on push to main"

  # ====================================
  # Build & Push Docker Images
  # ====================================
  build-user-management:
    name: ğŸ³ Build User Management
    runs-on: ubuntu-latest
    needs: [detect-changes, test-user-management]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/nutrifit-user-management
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: ğŸ”¨ Build and Push
        uses: docker/build-push-action@v5
        with:
          context: services/user-management
          file: services/user-management/Dockerfile
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-calorie-balance:
    name: ğŸ³ Build Calorie Balance  
    runs-on: ubuntu-latest
    needs: [detect-changes, test-calorie-balance]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/nutrifit-calorie-balance
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: ğŸ”¨ Build and Push
        uses: docker/build-push-action@v5
        with:
          context: services/calorie-balance
          file: services/calorie-balance/Dockerfile
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ====================================
  # Release (solo su main)
  # ====================================
  release:
    name: ğŸ“¦ Create Release
    runs-on: ubuntu-latest
    needs: [detect-changes, build-user-management, build-calorie-balance]
    if: always() && github.ref == 'refs/heads/main' && (needs.build-user-management.result == 'success' || needs.build-user-management.result == 'skipped') && (needs.build-calorie-balance.result == 'success' || needs.build-calorie-balance.result == 'skipped')
    
    steps:
      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: platform-v${{ github.run_number }}
          name: NutriFit Platform v${{ github.run_number }}
          body: |
            ## ğŸš€ Platform Release
            
            **Automatic deployment via Render Blueprint**
            
            ### Services & Docker Images
            - User Management: `ghcr.io/${{ github.repository_owner }}/nutrifit-user-management:main`
            - Calorie Balance: `ghcr.io/${{ github.repository_owner }}/nutrifit-calorie-balance:main`
            
            ### Infrastructure
            - Database: Supabase Cloud
            - Container Registry: GitHub Container Registry (ghcr.io)
            - Hosting: Render.com (auto-deploy from registry)
            - CI/CD: GitHub Actions â†’ GHCR â†’ Render Auto-Deploy
            
            ### Environment
            - Secret Files: Configured on Render
            - Environment Variables: Production .env loaded
            
            **Deploy Status**: Check [Render Dashboard](https://dashboard.render.com)
          generate_release_notes: true
