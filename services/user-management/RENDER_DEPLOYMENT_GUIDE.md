# üöÄ Render Deployment Guide - User Management Service

## üìã Pre-requisiti

- [x] Account Render.com attivo
- [x] Repository GitHub pubblico/privato con accesso
- [x] Credenziali Supabase pronte
- [x] Docker configurato e testato localmente

## üîß Step 1: Configurazione Render

### 1.1 Creazione del Web Service

1. **Login su Render.com**
2. **New ‚Üí Web Service**
3. **Connect Repository**: `https://github.com/giamma80/gymbro-platform`
4. **Configure Service**:
   ```
   Name: nutrifit-user-management
   Runtime: Docker
   Root Directory: services/user-management
   Dockerfile Path: ./Dockerfile
   Docker Build Target: production
   ```

### 1.2 Environment Variables (Required)

‚ö†Ô∏è **Configurare nel Render Dashboard**:

```bash
# Application
ENVIRONMENT=production
DEBUG=false
LOG_LEVEL=INFO
PORT=8000
DATABASE_SCHEMA=user_management

# Supabase (FROM YOUR .env FILE)
SUPABASE_URL=https://eipgaagzdoonlrnigtte.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc...
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc...

# Security (Auto-generated by Render)
SECRET_KEY=[AUTO-GENERATE]
JWT_SECRET_KEY=[AUTO-GENERATE]
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=60
JWT_REFRESH_TOKEN_EXPIRE_DAYS=30

# CORS
ALLOWED_ORIGINS=https://nutrifit.app,https://app.nutrifit.app

# Features
ENABLE_REAL_TIME=true
ENABLE_AUTH=true
ENABLE_STORAGE=false

# Performance
RATE_LIMIT_REQUESTS_PER_MINUTE=100
REQUEST_TIMEOUT_SECONDS=30
MAX_CONNECTIONS=200
WORKERS=2
```

### 1.3 Service Configuration

```yaml
Plan: Starter ($7/month)
Region: Oregon (or closest to users)
Health Check Path: /health
Auto-Deploy: true
Build Filter: services/user-management/**
```

## üîë Step 2: GitHub Secrets Configuration

### 2.1 Ottieni Render API Key

1. **Render Dashboard ‚Üí Account Settings ‚Üí API Keys**
2. **Create API Key** ‚Üí Copia il valore

### 2.2 Configura GitHub Secrets

**Repository ‚Üí Settings ‚Üí Secrets and Variables ‚Üí Actions**

```bash
# Required
RENDER_API_KEY=rnd_[your-api-key]
RENDER_PRODUCTION_SERVICE_ID=srv-[service-id]

# Optional
RENDER_STAGING_SERVICE_ID=srv-[staging-id]
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/...
```

### 2.3 Come ottenere Service ID

Dopo aver creato il servizio su Render:
- **URL del servizio**: `https://dashboard.render.com/web/srv-xxxxx`
- **Service ID**: `srv-xxxxx` (dalla URL)

## üöÄ Step 3: Deploy Process

### 3.1 Automatic Deploy (Recommended)

```bash
# Push to main branch triggers production deploy
git push origin main

# Push to develop branch triggers staging deploy  
git push origin develop
```

### 3.2 Manual Deploy

**GitHub ‚Üí Actions ‚Üí User Management Service CI/CD ‚Üí Run workflow**
- Select branch: `main`
- Deploy environment: `production`

## üìä Step 4: Verification

### 4.1 Health Check

```bash
curl https://nutrifit-user-management.onrender.com/health
# Expected: {"status":"healthy","service":"user-management","timestamp":...}
```

### 4.2 API Documentation

```bash
# Swagger UI
https://nutrifit-user-management.onrender.com/docs

# OpenAPI JSON
https://nutrifit-user-management.onrender.com/openapi.json
```

### 4.3 Logs Monitoring

**Render Dashboard ‚Üí Service ‚Üí Logs**
- Monitor startup logs
- Check for Supabase connection success
- Verify no JWT/import errors

## üîí Step 5: Security Checklist

- [x] Environment variables secured in Render
- [x] CORS origins restricted
- [x] Rate limiting enabled
- [x] HTTPS enforced automatically
- [x] Auto-generated secrets
- [x] No sensitive data in code

## üéØ Step 6: Domain Configuration (Optional)

### 6.1 Custom Domain

**Render Dashboard ‚Üí Service ‚Üí Settings ‚Üí Custom Domains**
```
api.nutrifit.app ‚Üí nutrifit-user-management.onrender.com
```

### 6.2 SSL Certificate

- Automatically provisioned by Render
- No manual configuration needed

## üìà Step 7: Monitoring & Scaling

### 7.1 Metrics to Monitor

- **Response time** (target: <200ms)
- **Error rate** (target: <1%)
- **Memory usage** (target: <80%)
- **CPU usage** (target: <70%)

### 7.2 Scaling

```yaml
# When to scale up:
- Response time > 500ms consistently
- Memory usage > 85%
- CPU usage > 80%

# Scale options:
- Increase plan (Standard/Pro)
- Add more instances
- Enable Redis caching
```

## üö® Troubleshooting

### Common Issues

1. **Build Failure**
   ```bash
   # Check Dockerfile path
   Root Directory: services/user-management
   Dockerfile Path: ./Dockerfile
   ```

2. **Environment Variables**
   ```bash
   # Verify in Render Dashboard
   # Check logs for missing variables
   ```

3. **Supabase Connection**
   ```bash
   # Verify credentials
   # Check database schema exists
   ```

4. **Port Configuration**
   ```bash
   # Ensure PORT=8000 in env vars
   # Dockerfile EXPOSE 8000
   ```

## üéâ Success Criteria

- ‚úÖ Service builds successfully
- ‚úÖ Health check returns 200
- ‚úÖ Supabase connection working
- ‚úÖ API documentation accessible
- ‚úÖ Auto-deploy working
- ‚úÖ No errors in logs

---

## üìû Next Steps

1. **Deploy to Render** following this guide
2. **Test endpoints** with real data
3. **Configure monitoring** and alerts
4. **Set up custom domain** if needed
5. **Scale as needed** based on usage

**Service URL**: https://nutrifit-user-management.onrender.com
**Documentation**: https://nutrifit-user-management.onrender.com/docs
