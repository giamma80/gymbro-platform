<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèãÔ∏è GymBro Platform - Test Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        .card { margin-bottom: 20px; }
        .status { padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        .status.success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .status.error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .chart-container { height: 300px; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Header -->
            <div class="col-12">
                <h1 class="text-center mt-3">üèãÔ∏è GymBro Platform - Test Dashboard</h1>
                <p class="text-center text-muted">Simple testing interface for Analytics & User Management services</p>
            </div>

            <!-- Status Panel -->
            <div class="col-12">
                <div id="status" class="status">
                    <strong>Status:</strong> <span id="status-text">Ready</span>
                </div>
            </div>

            <!-- Left Panel: Authentication & Data Input -->
            <div class="col-md-6">
                <!-- Authentication -->
                <div class="card" id="auth-card">
                    <div class="card-header">
                        <h5>üîê Authentication</h5>
                    </div>
                    <div class="card-body">
                        <div id="login-form">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" placeholder="user@example.com">
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" placeholder="password">
                            </div>
                            <button class="btn btn-primary w-100" onclick="login()">Login</button>
                            <hr>
                            <small class="text-muted">
                                <strong>Test User:</strong><br>
                                Email: test@gymbro.com<br>
                                Password: testpass123
                            </small>
                        </div>
                        <div id="user-info" class="d-none">
                            <div class="alert alert-success">
                                <strong>‚úÖ Authenticated as:</strong> <span id="user-display"></span>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" onclick="logout()">Logout</button>
                        </div>
                    </div>
                </div>

                <!-- Data Input (visible only when authenticated) -->
                <div class="card d-none" id="data-input-card">
                    <div class="card-header">
                        <h5>üìù Add Test Data</h5>
                    </div>
                    <div class="card-body">
                        <!-- User Selection -->
                        <div class="mb-3">
                            <label for="userId" class="form-label">User ID</label>
                            <input type="text" class="form-control" id="userId" placeholder="550e8400-e29b-41d4-a716-446655440000">
                            <div class="form-text">UUID del test user</div>
                        </div>

                        <!-- Daily Fitness Data -->
                        <h6>Daily Fitness Data</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <label for="steps" class="form-label">Steps</label>
                                    <input type="number" class="form-control form-control-sm" id="steps" placeholder="10000">
                                </div>
                                <div class="mb-2">
                                    <label for="calories" class="form-label">Calories Burned</label>
                                    <input type="number" class="form-control form-control-sm" id="calories" placeholder="500">
                                </div>
                                <div class="mb-2">
                                    <label for="weight" class="form-label">Weight (kg)</label>
                                    <input type="number" class="form-control form-control-sm" id="weight" step="0.1" placeholder="70.5">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <label for="sleep" class="form-label">Sleep Hours</label>
                                    <input type="number" class="form-control form-control-sm" id="sleep" step="0.1" placeholder="7.5">
                                </div>
                                <div class="mb-2">
                                    <label for="heartRate" class="form-label">Resting HR</label>
                                    <input type="number" class="form-control form-control-sm" id="heartRate" placeholder="65">
                                </div>
                                <div class="mb-2">
                                    <label for="mood" class="form-label">Mood (1-10)</label>
                                    <input type="number" class="form-control form-control-sm" id="mood" min="1" max="10" placeholder="7">
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-primary w-100 mb-3" onclick="addFitnessData()">Add Fitness Data</button>

                        <!-- Quick Activity -->
                        <h6>Quick Activity</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <select class="form-control form-control-sm mb-2" id="activityType">
                                    <option value="running">Running</option>
                                    <option value="weightlifting">Weightlifting</option>
                                    <option value="cycling">Cycling</option>
                                    <option value="yoga">Yoga</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <input type="number" class="form-control form-control-sm mb-2" id="duration" placeholder="30" title="Duration (minutes)">
                            </div>
                        </div>
                        <button class="btn btn-success w-100" onclick="addActivity()">Add Activity</button>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h5>‚ö° Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-outline-primary me-2 mb-2" onclick="generateMockWeek()">Generate Mock Week</button>
                        <button class="btn btn-outline-info me-2 mb-2" onclick="checkServices()">Check Services</button>
                        <button class="btn btn-outline-warning mb-2" onclick="clearData()">Clear Display</button>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Analytics Results -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä Analytics Results</h5>
                        <button class="btn btn-sm btn-outline-success" onclick="loadAnalytics()">Refresh Analytics</button>
                    </div>
                    <div class="card-body">
                        <div id="analytics-results">
                            <p class="text-muted">Click "Refresh Analytics" to see results</p>
                        </div>
                    </div>
                </div>

                <!-- Simple Chart -->
                <div class="card">
                    <div class="card-header">
                        <h5>üìà Simple Chart</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="simpleChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Use API Proxy to avoid CORS
        const USER_MANAGEMENT_URL = '/api/proxy/user-management';
        const ANALYTICS_URL = '/api/proxy/analytics';
        
        // Global authentication state
        let currentUser = null;
        let authToken = null;
        
        // Default test user (created with create_test_user.py)
        document.getElementById('userId').value = 'a791e51d-9d49-4c79-8a63-2ff3a1857b0c';

        // Authentication functions
        function getStoredAuth() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('currentUser');
            if (token && user) {
                authToken = token;
                currentUser = JSON.parse(user);
                showAuthenticatedState();
                return true;
            }
            return false;
        }
        
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showStatus('‚ùå Please enter both email and password', 'error');
                return;
            }
            
            try {
                // Send JSON data, not form data
                const response = await fetch('/api/proxy/user-management/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    currentUser = { email: email, token_type: data.token_type };
                    
                    // Store in localStorage
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showAuthenticatedState();
                    showStatus('‚úÖ Successfully authenticated!', 'success');
                } else {
                    const errorData = await response.json().catch(() => ({ detail: 'Authentication failed' }));
                    showStatus('‚ùå Authentication failed: ' + (errorData.detail || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showStatus('‚ùå Login error: ' + error.message, 'error');
            }
        }
        
        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            showLoginState();
            showStatus('üîì Logged out', 'info');
        }
        
        function showAuthenticatedState() {
            document.getElementById('login-form').classList.add('d-none');
            document.getElementById('user-info').classList.remove('d-none');
            document.getElementById('user-display').textContent = currentUser.email;
            document.getElementById('data-input-card').classList.remove('d-none');
        }
        
        function showLoginState() {
            document.getElementById('login-form').classList.remove('d-none');
            document.getElementById('user-info').classList.add('d-none');
            document.getElementById('data-input-card').classList.add('d-none');
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }
        
        // Enhanced API call with authentication
        async function apiCall(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            // Add authentication header if we have a token
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            const response = await fetch(url, {
                ...options,
                headers
            });
            
            // Handle authentication errors
            if (response.status === 401) {
                showStatus('üîê Authentication required or token expired', 'error');
                logout(); // Force logout on auth failure
                throw new Error('Authentication required');
            }
            
            return response;
        }

        // Status functions
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            statusDiv.className = `status ${type}`;
            statusText.textContent = message;
        }

        // Add fitness data
        async function addFitnessData() {
            if (!authToken) {
                showStatus('‚ùå Please login first', 'error');
                return;
            }
            
            const userId = document.getElementById('userId').value;
            if (!userId.trim()) {
                showStatus('‚ùå User ID is required', 'error');
                return;
            }
            
            const data = {
                date: new Date().toISOString().split('T')[0], // Solo data YYYY-MM-DD
                steps: parseInt(document.getElementById('steps').value) || null,
                active_minutes: null, // Non presente nel form, potremmo aggiungerlo
                calories_burned: parseFloat(document.getElementById('calories').value) || null,
                calories_consumed: null, // Non presente nel form
                weight_kg: parseFloat(document.getElementById('weight').value) || null,
                sleep_hours: parseFloat(document.getElementById('sleep').value) || null
            };

            try {
                showStatus('Adding fitness data...', 'info');
                console.log('Sending data to:', `${USER_MANAGEMENT_URL}/fitness/daily-data`);
                console.log('Data:', data);
                
                const response = await apiCall(`${USER_MANAGEMENT_URL}/fitness/daily-data`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Response:', result);
                    showStatus(`‚úÖ Fitness data added successfully!`);
                    // Clear form
                    ['steps', 'calories', 'weight', 'sleep', 'heartRate', 'mood'].forEach(id => 
                        document.getElementById(id).value = '');
                } else {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showStatus(`‚ùå Error adding fitness data: ${error.message}`, 'error');
            }
        }

        // Add activity
        async function addActivity() {
            if (!authToken) {
                showStatus('‚ùå Please login first', 'error');
                return;
            }
            
            const userId = document.getElementById('userId').value;
            const data = {
                user_id: userId,
                activity_type: document.getElementById('activityType').value,
                duration_minutes: parseInt(document.getElementById('duration').value) || 30,
                calories_burned: parseInt(document.getElementById('duration').value) * 8 || 240, // rough estimate
                start_time: new Date().toISOString(),
                intensity_level: 'moderate'
            };

            try {
                showStatus('Adding activity...', 'info');
                const response = await apiCall(`${USER_MANAGEMENT_URL}/activities`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showStatus(`‚úÖ Activity "${data.activity_type}" added successfully!`);
                    document.getElementById('duration').value = '';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showStatus(`‚ùå Error adding activity: ${error.message}`, 'error');
            }
        }

        // Load analytics
        async function loadAnalytics() {
            const userId = document.getElementById('userId').value;
            
            try {
                showStatus('Loading analytics...', 'info');
                const response = await fetch(`${ANALYTICS_URL}/api/v1/analytics/users/${userId}/enhanced-dashboard`);
                
                if (response.ok) {
                    const analytics = await response.json();
                    displayAnalytics(analytics);
                    updateChart(analytics);
                    showStatus('‚úÖ Analytics loaded successfully!');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showStatus(`‚ùå Error loading analytics: ${error.message}`, 'error');
                document.getElementById('analytics-results').innerHTML = 
                    `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        // Display analytics results
        function displayAnalytics(data) {
            const container = document.getElementById('analytics-results');
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>üìä Basic Metrics</h6>
                        <ul class="list-unstyled">
                            <li>üìà Total Records: ${data.summary?.total_records || 0}</li>
                            <li>üî• Avg Calories: ${Math.round(data.summary?.avg_calories_burned || 0)}</li>
                            <li>üëü Avg Steps: ${Math.round(data.summary?.avg_steps || 0)}</li>
                            <li>üò¥ Avg Sleep: ${(data.summary?.avg_sleep_hours || 0).toFixed(1)}h</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>üèÉ Activities</h6>
                        <ul class="list-unstyled">
                            <li>üìÖ Last 7 days: ${data.recent_activities?.length || 0}</li>
                            <li>‚è±Ô∏è Total Duration: ${Math.round(data.total_activity_duration || 0)}min</li>
                            <li>üî• Activity Calories: ${Math.round(data.activity_calories || 0)}</li>
                        </ul>
                    </div>
                </div>
                
                ${data.insights ? `
                <div class="mt-3">
                    <h6>üí° Insights</h6>
                    <div class="alert alert-info">
                        ${data.insights.metabolic_health || 'No metabolic insights available'}
                    </div>
                </div>
                ` : ''}
            `;
        }

        // Simple chart
        let chart = null;
        function updateChart(data) {
            const ctx = document.getElementById('simpleChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            const sampleData = data.fitness_history?.slice(-7) || [];
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sampleData.map(d => new Date(d.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Steps',
                        data: sampleData.map(d => d.steps),
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }, {
                        label: 'Calories',
                        data: sampleData.map(d => d.calories_burned),
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Quick actions
        function generateMockWeek() {
            showStatus('Generating mock week data...', 'info');
            
            // Generate 7 days of mock data
            for(let i = 0; i < 7; i++) {
                const steps = Math.floor(Math.random() * 5000) + 7000;
                const calories = Math.floor(Math.random() * 300) + 400;
                const weight = 70 + (Math.random() - 0.5) * 2;
                const sleep = 6.5 + Math.random() * 2;
                
                document.getElementById('steps').value = steps;
                document.getElementById('calories').value = calories;
                document.getElementById('weight').value = weight.toFixed(1);
                document.getElementById('sleep').value = sleep.toFixed(1);
                document.getElementById('heartRate').value = Math.floor(Math.random() * 15) + 60;
                document.getElementById('mood').value = Math.floor(Math.random() * 3) + 7;
                
                setTimeout(() => addFitnessData(), i * 500);
            }
            
            setTimeout(() => {
                showStatus('‚úÖ Mock week generated! Refresh analytics to see results.');
            }, 4000);
        }

        async function checkServices() {
            showStatus('Checking services...', 'info');
            let results = [];

            try {
                const userMgmtResponse = await fetch(`${USER_MANAGEMENT_URL}/health`);
                results.push(`User Management: ${userMgmtResponse.ok ? '‚úÖ' : '‚ùå'}`);
            } catch (e) {
                results.push('User Management: ‚ùå Not available');
            }

            try {
                const analyticsResponse = await fetch(`${ANALYTICS_URL}/health`);
                results.push(`Analytics: ${analyticsResponse.ok ? '‚úÖ' : '‚ùå'}`);
            } catch (e) {
                results.push('Analytics: ‚ùå Not available');
            }

            showStatus(results.join(' | '));
        }

        function clearData() {
            document.getElementById('analytics-results').innerHTML = '<p class="text-muted">Cleared</p>';
            if (chart) {
                chart.destroy();
                chart = null;
            }
            showStatus('Display cleared');
        }

        // Initialize
        function initialize() {
            checkServices();
            getStoredAuth(); // Check for existing authentication
        }
        
        // Start initialization when page loads
        window.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
